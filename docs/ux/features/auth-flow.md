# F1: 인증 & 유저 관리 - 사용자 여정 (User Journey)

**Feature ID**: F1
**버전**: v1.0
**작성일**: 2025-11-12
**상위 문서**: `docs/project/features/f1-auth.md`

---

## 개요

이 문서는 F1 (인증 & 유저 관리) 기능의 모든 사용자 여정을 정의한다.
각 여정은 사용자의 진입점부터 목표 달성까지의 단계별 흐름을 설명한다.

---

## 1. 점주 회원가입 여정

### 1.1 플로우 개요

**시작점**: 랜딩 페이지 진입
**목표**: 계정 생성 + 매장 생성 + 대시보드 진입
**예상 소요 시간**: 3~5분

### 1.2 단계별 여정

**Step 1: 랜딩 페이지 진입**
- 사용자가 `https://bestpractice.com` 접속
- 메인 메시지 노출: "성공하는 사장님의 비법을, 그대로 시스템으로"
- CTA 버튼: "무료로 시작하기" 클릭

**Step 2: 회원가입 폼 (`/auth/signup`)**
- 역할 선택 라디오 버튼: "점주(Owner)" 선택 (기본값)
- 입력 필드:
  - 이름 (필수)
  - 이메일 (필수, 이메일 형식 검증)
  - 비밀번호 (필수, 최소 8자, 영문+숫자 조합)
  - 비밀번호 확인 (필수, 일치 검증)
  - 전화번호 (선택)
- 약관 동의 체크박스 (필수)
- "가입하기" 버튼 클릭

**Step 3: 회원가입 처리**
- 로딩 인디케이터 표시
- 서버 요청: `POST /auth/signup`
- 성공 시:
  - Access Token + Refresh Token 발급받아 저장
  - 자동 로그인 상태로 전환
  - Step 4로 이동
- 실패 시:
  - 에러 메시지 표시 (예: "이미 가입된 이메일입니다")
  - 폼에 머물러 수정 가능

**Step 4: 매장 정보 입력 (`/stores/new`)**
- 안내 메시지: "매장 정보를 입력해주세요"
- 입력 필드:
  - 매장명 (필수, 2~50자)
  - 업종 (선택 드롭다운: 카페, 음식점, 소매점 등)
  - 주소 (필수, 주소 검색 API 연동)
  - GPS 좌표 (주소 기반 자동 입력)
- "다음" 버튼 클릭

**Step 5: 온보딩 화면 (`/onboarding`)**
- 환영 메시지: "환영합니다! 첫 매뉴얼을 만들어보세요"
- 온보딩 튜토리얼 (선택):
  - "5분 매뉴얼 만들기" 가이드
  - "직원 초대하기" 가이드
- "건너뛰기" / "시작하기" 버튼

**Step 6: 대시보드 진입 (`/dashboard` 또는 `/stores/[id]`)**
- 점주 역할 대시보드 표시
- 위젯:
  - "오늘의 근무 현황" (아직 직원 없음 표시)
  - "내 매장" 카드
  - "직원 초대하기" CTA

### 1.3 관련 AC

- **AC-F1-01**: 회원가입 시 users, stores 테이블에 데이터 저장
- **AC-F1-02**: 이메일 중복 시 에러 반환
- **AC-F1-03**: JWT Access Token(24h), Refresh Token(30d) 발급

---

## 2. 직원 회원가입 여정

### 2.1 플로우 개요

**시작점**: 점주가 보낸 초대 링크 클릭
**목표**: 계정 생성 + 매장 자동 참여
**예상 소요 시간**: 2~3분

### 2.2 단계별 여정

**Step 1: 초대 링크 클릭**
- 직원이 이메일로 받은 초대 링크 클릭
- URL 형식: `https://bestpractice.com/auth/signup?inviteCode=ABC123`
- 자동으로 회원가입 폼으로 이동
- 초대 코드가 URL 파라미터로 전달됨

**Step 2: 회원가입 폼 (`/auth/signup?inviteCode=ABC123`)**
- 초대받은 매장 정보 표시: "카페 OO에서 초대했어요"
- 역할 자동 선택: "직원(Employee)" (비활성화, 변경 불가)
- 입력 필드:
  - 이름 (필수)
  - 이메일 (필수, 초대 이메일과 일치 권장)
  - 비밀번호 (필수, 최소 8자)
  - 비밀번호 확인 (필수)
  - 전화번호 (선택)
- "가입하기" 버튼 클릭

**Step 3: 회원가입 처리 (초대 코드 검증 포함)**
- 로딩 인디케이터 표시
- 서버 요청: `POST /auth/signup` (body에 inviteCode 포함)
- 초대 코드 검증:
  - 유효한 코드인지 확인
  - 만료되지 않았는지 확인
  - 해당 매장에 자동 참여 처리
- 성공 시:
  - Access Token + Refresh Token 발급
  - 자동 로그인
  - Step 4로 이동
- 실패 시:
  - 에러 메시지 (예: "초대 링크가 만료되었습니다")

**Step 4: 직원 대시보드 진입 (`/dashboard` 또는 `/my-manuals`)**
- 직원 역할 대시보드 표시
- 위젯:
  - "내 매뉴얼" 목록 (아직 할당 없음)
  - "오늘의 출근 체크인" 버튼
  - "내 근무 시간" 요약

### 2.3 관련 AC

- **AC-F1-01**: 회원가입 시 users 테이블에 데이터 저장, employees 관계 생성
- **AC-F1-02**: 이메일 중복 시 에러 반환
- **AC-F1-03**: JWT 토큰 발급

---

## 3. 로그인 여정

### 3.1 플로우 개요

**시작점**: 로그인 페이지 진입
**목표**: 인증 후 역할별 대시보드 리다이렉트
**예상 소요 시간**: 30초

### 3.2 단계별 여정

**Step 1: 로그인 페이지 진입 (`/auth/login`)**
- 입력 필드:
  - 이메일 (필수)
  - 비밀번호 (필수)
- "로그인" 버튼
- "비밀번호 찾기" 링크 (Phase 2 구현 예정)
- "계정이 없으신가요? 가입하기" 링크

**Step 2: 로그인 처리**
- 로딩 인디케이터 표시
- 서버 요청: `POST /auth/login`
- 성공 시:
  - Access Token + Refresh Token 발급받아 저장
  - 사용자 정보 조회 (`GET /auth/me`)
  - 역할(role) 확인
  - Step 3로 이동
- 실패 시:
  - 에러 메시지: "이메일 또는 비밀번호가 잘못되었습니다"
  - 폼 초기화 (비밀번호만 클리어)

**Step 3: 역할별 리다이렉트**
- **OWNER 역할**:
  - → `/dashboard` 또는 `/stores/[id]` (점주 대시보드)
- **EMPLOYEE 역할**:
  - → `/my-manuals` 또는 `/attendance/my-records` (직원 대시보드)
- **MANAGER 역할** (Phase 2):
  - → `/stores/[id]/manage` (매니저 대시보드)

### 3.3 관련 AC

- **AC-F1-03**: JWT 토큰 발급
- **AC-F1-04**: 잘못된 비밀번호 시 INVALID_CREDENTIALS 에러
- **AC-F1-05**: RBAC 역할별 접근 제어

---

## 4. 프로필 관리 여정

### 4.1 플로우 개요

**시작점**: 대시보드 또는 상단 메뉴에서 "프로필" 클릭
**목표**: 개인 정보 조회 및 수정
**예상 소요 시간**: 1~2분

### 4.2 단계별 여정

**Step 1: 프로필 페이지 진입 (`/profile`)**
- 사용자 정보 조회 (`GET /auth/me`)
- 프로필 카드 표시:
  - 이름
  - 이메일 (읽기 전용)
  - 전화번호
  - 역할 (읽기 전용, 배지로 표시)
  - 가입일 (읽기 전용)
- "수정하기" 버튼

**Step 2: 프로필 수정 모드**
- "수정하기" 버튼 클릭 시:
  - 편집 가능한 필드만 활성화:
    - 이름 (수정 가능)
    - 전화번호 (수정 가능)
  - 비밀번호 변경 섹션 표시 (선택):
    - 현재 비밀번호 (필수)
    - 새 비밀번호 (필수, 최소 8자)
    - 새 비밀번호 확인 (필수)
- "저장" / "취소" 버튼

**Step 3: 프로필 업데이트**
- "저장" 버튼 클릭 시:
  - 로딩 인디케이터 표시
  - 서버 요청: `PATCH /users/me`
  - 비밀번호 변경 시: `POST /auth/change-password`
- 성공 시:
  - 토스트 알림: "프로필이 업데이트되었습니다"
  - 읽기 모드로 전환
  - 최신 데이터로 화면 갱신
- 실패 시:
  - 에러 메시지 표시 (예: "현재 비밀번호가 일치하지 않습니다")

### 4.3 관련 AC

- **AC-F1-07**: 프로필 조회 시 비밀번호 해시 제외

---

## 5. 에러 처리 플로우

### 5.1 이메일 중복 에러 플로우

**발생 시점**: 회원가입 시 (`POST /auth/signup`)

**단계별 처리**:
1. 서버 응답: `400 Bad Request`
   - 에러 코드: `EMAIL_ALREADY_EXISTS`
   - 메시지: "이미 가입된 이메일입니다"
2. UI 처리:
   - 이메일 입력 필드 하단에 빨간색 에러 메시지 표시
   - 이메일 입력 필드에 빨간 테두리 강조
   - "로그인하기" 링크 제공
3. 사용자 액션:
   - 다른 이메일 입력
   - 또는 "로그인하기" 링크 클릭 → `/auth/login` 이동

**관련 AC**: AC-F1-02

---

### 5.2 잘못된 비밀번호 에러 플로우

**발생 시점**: 로그인 시 (`POST /auth/login`)

**단계별 처리**:
1. 서버 응답: `401 Unauthorized`
   - 에러 코드: `INVALID_CREDENTIALS`
   - 메시지: "이메일 또는 비밀번호가 잘못되었습니다"
2. UI 처리:
   - 폼 상단에 에러 Alert 컴포넌트 표시
   - 비밀번호 필드만 클리어 (이메일은 유지)
   - 비밀번호 필드에 포커스
   - "비밀번호 찾기" 링크 강조 (Phase 2)
3. 사용자 액션:
   - 비밀번호 재입력
   - 또는 "비밀번호 찾기" 클릭 (Phase 2)

**관련 AC**: AC-F1-04

---

### 5.3 네트워크 실패 에러 플로우

**발생 시점**: 모든 API 요청

**단계별 처리**:
1. 네트워크 에러 감지:
   - `fetch()` 또는 Axios 에러 catch
   - 타임아웃 (30초 기준)
   - 서버 5xx 에러
2. UI 처리:
   - Toast 알림: "네트워크 연결을 확인해주세요"
   - 로딩 인디케이터 숨김
   - "다시 시도" 버튼 표시
3. 사용자 액션:
   - "다시 시도" 버튼 클릭 → 이전 요청 재시도
   - 또는 페이지 새로고침

**관련 AC**: 모든 AC (네트워크 안정성)

---

### 5.4 토큰 만료 에러 플로우

**발생 시점**: 인증이 필요한 API 요청 시

**단계별 처리**:
1. 서버 응답: `401 Unauthorized`
   - 에러 코드: `TOKEN_EXPIRED`
2. 자동 토큰 갱신 시도:
   - Refresh Token으로 `POST /auth/refresh` 요청
   - 성공 시:
     - 새 Access Token 발급받아 저장
     - 원래 요청 재시도 (사용자는 인지 못함)
   - 실패 시 (Refresh Token도 만료):
     - Step 3으로 이동
3. 로그아웃 처리:
   - 토큰 삭제 (localStorage/cookie)
   - Redux 상태 초기화
   - `/auth/login` 페이지로 리다이렉트
   - Toast 알림: "세션이 만료되었습니다. 다시 로그인해주세요"

**관련 AC**: AC-F1-06

---

### 5.5 권한 없음 에러 플로우 (RBAC)

**발생 시점**: 역할에 맞지 않는 페이지 접근 시

**예시**:
- 직원이 `/stores/[id]/employees` (점주 전용 페이지) 접근
- 점주가 다른 점주의 매장 페이지 접근

**단계별 처리**:
1. 서버 응답: `403 Forbidden`
   - 에러 코드: `FORBIDDEN`
   - 메시지: "접근 권한이 없습니다"
2. UI 처리:
   - 에러 페이지 표시 (`/403`)
   - 메시지: "이 페이지에 접근할 권한이 없습니다"
   - "대시보드로 돌아가기" 버튼
3. 사용자 액션:
   - "대시보드로 돌아가기" → 역할별 대시보드로 이동

**관련 AC**: AC-F1-05

---

## 6. 토큰 관리 플로우

### 6.1 토큰 저장 전략

**Access Token (24시간)**:
- 저장 위치: `localStorage` 또는 `httpOnly cookie` (보안 우선 시)
- Redux Store에도 저장 (메모리)
- API 요청 시 `Authorization: Bearer {token}` 헤더에 포함

**Refresh Token (30일)**:
- 저장 위치: `httpOnly cookie` (보안 우선) 또는 `localStorage`
- Redux Store에는 저장하지 않음 (보안상)

### 6.2 자동 토큰 갱신 플로우

**트리거**: API 응답이 `401 TOKEN_EXPIRED`일 때

**처리 순서**:
1. Axios/Fetch Interceptor에서 401 에러 감지
2. Refresh Token 존재 확인
3. `POST /auth/refresh` 요청
   - Body: `{ refreshToken: "..." }`
4. 성공 시:
   - 새 Access Token 저장
   - 원래 실패한 요청 재시도
5. 실패 시:
   - 로그아웃 처리 (5.4 참조)

---

## 7. UX 개선 요소

### 7.1 로딩 상태

- **버튼 클릭 시**: 버튼에 스피너 + "처리 중..." 텍스트
- **페이지 전환 시**: 전체 화면 스피너 + "잠시만 기다려주세요"
- **Skeleton UI**: 프로필 로딩 시 카드 Skeleton 표시

### 7.2 성공 피드백

- **회원가입 성공**: 환영 모달 + "환영합니다!" 메시지
- **로그인 성공**: 부드러운 페이지 전환 (fade in)
- **프로필 업데이트 성공**: Toast 알림 (우상단, 3초 후 자동 사라짐)

### 7.3 폼 Validation UX

- **실시간 Validation**: 입력 필드 focus out 시 즉시 검증
- **에러 표시**: 필드 하단에 빨간색 텍스트 + 아이콘
- **성공 표시**: 유효한 입력 시 녹색 체크 아이콘
- **비밀번호 강도 표시**: 약함/보통/강함 인디케이터

### 7.4 접근성 (Accessibility)

- 모든 폼 필드에 `<label>` 연결
- 에러 메시지에 `role="alert"` 속성
- 키보드 네비게이션 지원 (Tab, Enter)
- ARIA 속성 적용 (`aria-invalid`, `aria-describedby`)

---

## 8. 여정별 예상 지표 (KPI)

| 여정 | 예상 소요 시간 | 주요 이탈 포인트 | 목표 완료율 |
|------|---------------|-----------------|------------|
| 점주 회원가입 | 3~5분 | Step 4 (매장 정보 입력) | 70% 이상 |
| 직원 회원가입 | 2~3분 | Step 2 (초대 코드 검증 실패) | 85% 이상 |
| 로그인 | 30초 | Step 2 (비밀번호 오류) | 95% 이상 |
| 프로필 수정 | 1~2분 | - | 90% 이상 |

---

## 9. 다음 단계 (Phase 2 예정)

- **소셜 로그인**: Google, Kakao 연동
- **비밀번호 찾기**: 이메일 인증 기반 재설정
- **이메일 인증**: 회원가입 시 이메일 인증 필수화
- **2단계 인증 (2FA)**: SMS 또는 TOTP 기반

---

**Last Updated**: 2025-11-12
**Status**: F1 Step 1 작성 완료
**Next**: `docs/ux/features/auth-screens.md` 작성
